# stripe-eccube-4-v2

Copyright Subspire Inc. 2020

[EC-CUBE](http://www.ec-cube.net)用の[Stripe](https://stripe.com/)の決済プラグインです。

このプラグインはEC-CUBE上での買い物をStripeで決済する機能を提供します。
決済のみを行うシンプルなプラグインで、受注や集計はEC-CUBEで管理する方針です。
購入者のクレジットカード情報はデータベースに保存せず、ショップのオーナーも見ることはできません。

「認証と売上処理」設定の場合はチェックアウト時にオーソリと売上処理が行われて、EC-CUBEに入ってくる注文は自動的に【入金済み】ステータスに更新されます。また、ポイント反映もこの時点で自動的に行われます。

「認証のみ」設定の場合はチェックアウト時に認証のみ行われて、EC-CUBE管理画面上から支払い請求・払い戻しができます。支払い請求時は注文が自動的に【入金済み】ステータスに更新されます。また、ポイント反映もこの時点で自動的に行われます。払い戻し時は注文が自動的に【注文取消し】ステータスに更新されます。

本プラグインで利用可能な決済方法はVisa, Mastercard, JCB, AMEX, Diners, Discover, Apple Pay, Google Payです。

Apple PayとGoogle Payは商品詳細ページ・カートページ・チェックアウトページでの決済ボタン表示でワンクリックで注文を行うことが可能です。

## 機能

- [STRIPE](https://stripe.com/)にて簡単な登録を行うことで試せます。
- [トークン](https://stripe.com/docs/api#tokens)を利用して安全に購入処理をします。
- カード情報は Stripe のサーバに安全に格納されます。
- カード情報非通過対応済み
- カード保存機能
- 認証のみ・認証と売上処理の決済方法が可能
- EC-CUBE管理画面で支払い請求・払い戻しができる
- EC-CUBE管理画面で手数料を引いた返金及び一部返金ができる
- EC-CUBE管理画面で各注文の Stripe 取引詳細リンクを表示
- 他通貨対応
- 3D Secure 2対応
- Apple Pay対応
- Google Pay対応
- 拡張プラグインにて定期購入対応（https://subspire.co.jp/product/stripe-eccube-4-recurring/）

## 対応環境

- EC-CUBE 4.0.0 以上

## インストール方法

1) プラグインを管理画面からインストールします。

```
1-1) EC-CUBE管理画面の【オーナーズストア】→【プラグイン】→【プラグイン一覧】から
【アップロードして新規追加】のボタンをクリックしていただいて、その後本プラグインのZIPファイルを
選択していただいて、アップロードしていただけます。

1-2) EC-CUBE管理画面の【オーナーズストア】→【プラグイン】→【プラグイン一覧】から
【Stripe 決済プラグイン】の【有効にする】をクリックしてください。

1-3) EC-CUBE管理画面の【コンテンツ管理】→【キャッシュ管理】で【キャッシュ削除】を押していただきキャッシュをクリアしてください。

※システムエラーが発生する場合は下記の手順をご確認いただき、SSHまたはFTPでのキャッシュクリアなどを行ってください。
https://doc4.ec-cube.net/plugin_error

1-4) EC-CUBE管理画面の【Stripe管理】→【設定】にてライセンスキーとご購入時にご利用いただいたメールアドレスをご入力ください。
ライセンス認証は1回だけ行えます。先にテスト用でご利用いただく場合は【テスト環境】ボタンを押してください。
テストが完了してテストと本番が同じ環境でしたら一度プラグインをアンインストールしていただき、再度インストールしていただきライセンス認証を行ってください。
また、追加分のライセンスキーが必要でしたら弊社までご連絡ください。1ライセンスにつき一つのEC-CUBE環境でご利用いただけます。

1-5) EC-CUBE管理画面の【Stripe管理】→【設定】にてご自身のAPIキーを登録してください。
Stripeにてメールアドレスを登録するだけでAPIキーを取得できます。
また、認証のみ・認証と売上処理の決済方法も選択してください。
最後にStripe手数料の割合を入力してください。こちらは手数料を引いた返金で利用される割合（%）です。

1-6) Apple Pay / Google Payをご利用いただく場合は「Apple Pay / Google Payの提供」でApple Pay / Google Payの決済ボタンを表示させるページにチェックを入れてください。

※「商品詳細ページ」と「カートページに表示」で決済が行われた場合はEC-CUBE管理画面上での決済方法がApple PayまたはGoogle Payとして表示されます。「カード決済ページ」で決済が行われた場合は「クレジットカード」として表示されます。

※Apple Pay / Google Payの決済ボタンを表示させるために、Stripe管理画面の【設定】→【支払方法】→【Apple Pay】の設定ページでWebドメインを追加していただく必要があります。

1-7) EC-CUBE管理画面の【設定】→【店舗設定】→【配送方法設定】から対象になる配送方法で【クレジットカード】のチェックを入れて保存してください。

その後、チェックアウトでStripeが利用可能になります。
```

## アップデート方法

旧バージョンからのアップデート方法が下記になります。アップデート時は必ず下記の手順でアップデートをお願いいたします。

1) プラグインを管理画面から更新します。

```
1-1) EC-CUBE管理画面の【オーナーズストア】→【プラグイン】→【プラグイン一覧】からプラグインを無効にします。

1-2) EC-CUBE管理画面の【オーナーズストア】→【プラグイン】→【プラグイン一覧】からプラグインを更新します。

1-3) EC-CUBE管理画面の【オーナーズストア】→【プラグイン】→【プラグイン一覧】からプラグインを有効にします。

1-4) EC-CUBE管理画面の【コンテンツ管理】→【キャッシュ管理】で【キャッシュ削除】を押していただきキャッシュをクリアしてください。
```

## 利用方法

- EC-CUBE管理画面の【設定】→【店舗設定】→【配送方法設定】から対象になる配送方法で【クレジットカード】のチェックを入れて保存してください。

- 商品を購入する際に、支払方法に「クレジットカード」を選択すると、チェックアウトの最後にカード情報を入力できるページが表示されます。

- テスト環境では[テストカード](https://stripe.com/docs/testing)を利用して試すことが可能です。